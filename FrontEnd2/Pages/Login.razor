@page "/Login"
@using BBCollection.BBObjects;
@using BBCollection.DBConncetion;
@using BBCollection.DBHandling;
@using Newtonsoft.Json;
@using  System.Text;
@using FrontEnd2.Data;
@using System;
@using System.Collections;
@using System.Diagnostics;
@inject HttpClient Http
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject NavigationManager NavigationManager


<h1>Login</h1>
@*<input class="SearchField SearchBar" placeholder="Email" @bind="@email" />
<input class="SearchField SearchBar" type="password" placeholder="Password" @bind="@password" />
<button class="btn btn-rounded btn-outline-success" @onclick="AutorizeLogin">Login</button>*@

<div class="d-flex flex-column mb-3">
    <div class="p-2">
        <input class="SearchField SearchBar" placeholder="Username or e-mail" @onkeyup="@OnKeyPress" @bind="@email" autofocus/>
    </div>
    <div class="p-2">
        <input class="SearchField SearchBar" type="password" placeholder="Password" @onkeyup="@OnKeyPress" @bind="@password" />
    </div>
    <div class="p-2">
        @if (isLogginIn)
        {
            <button class="btn btn-rounded btn-outline-success search disabled" disabled><span class='fa-left fas fa-sync-alt spinning'></span>Logging in...</button>
        }
        else
        {
            <button class="btn btn-rounded btn-outline-success search" @onclick="(() => AutorizeLogin())">Login</button>
        }
    </div>
    <div class="p-2">
        <p>If you have not yet created an account, please press the button below.</p>
    </div>
    <div class="p-2">
        <a class="btn btn-rounded btn-success" href="Register"><i class="oi oi-person"></i>&nbsp; Register</a>
    </div>
</div>

@code{
    string email;
    string password;
    string userString;
    bool isLogginIn = false;
    ConnectionSettings connectionSettings = new ConnectionSettings();
    LoginRegister account = new LoginRegister();

    private async Task OnKeyPress(KeyboardEventArgs args)
    {
        if (args.Key == "Enter")
        {
            await AutorizeLogin();
        }
    }

    protected async Task AutorizeLogin()
    {
        isLogginIn = true;
        StateHasChanged();
        await localStorage.RemoveItemAsync("ProductString");

        var response = new HttpResponseMessage();

        User user = new User(email, password);

        response = await account.Login(user);

        if (response.IsSuccessStatusCode)
        {

            await localStorage.SetItemAsync("Email", email);
            NavigationManager.NavigateTo("shoppinglist");
        }
        else
        {
            Debug.WriteLine("Testing Remove");
            await localStorage.RemoveItemAsync("Email");
        }
        isLogginIn = false;
        StateHasChanged();
    }





    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await GetLocalSession();

            StateHasChanged();
        }
    }

    async Task GetLocalSession()
    {
        email = await localStorage.GetItemAsync<string>("Email");
    }
}
